<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7832188543711021" crossorigin="anonymous"></script>
    
    <title>×¤××–×œ ×”×–×–×”</title>
    
    <style>
        :root {
            --primary: #FF9F43; 
            --primary-shadow: #E67E22;
            --bg-gradient: linear-gradient(135deg, #E0F7FA 0%, #B2EBF2 100%);
            --board-frame: #FFF9C4;
            --text-color: #5D4037;
            --btn-radius: 25px;
            --radius-md: 16px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* --- Layout --- */
        .main-layout {
            display: flex;
            width: 100%;
            max-width: 1400px;
            justify-content: center;
            align-items: flex-start;
            padding: 10px;
            gap: 20px;
        }

        .game-column {
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        /* --- Ads Layout (Narrow Banners) --- */
        .ad-sidebar {
            display: none; 
            width: 160px;
            height: 600px;
            background: rgba(255,255,255,0.4);
            border-radius: var(--radius-md);
            position: sticky;
            top: 20px;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .ad-mobile {
            width: 100%;
            height: 50px;
            background: rgba(255,255,255,0.4);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
        }

        @media (min-width: 1024px) {
            .ad-sidebar { display: flex; }
            .ad-mobile { display: none; }
        }

        /* --- Header & Gallery --- */
        header {
            width: 100%;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
        }

        .gallery-scroller {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 5px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .gallery-scroller::-webkit-scrollbar { display: none; }

        .gallery-item {
            width: 65px; height: 65px; border-radius: 18px; object-fit: cover;
            opacity: 0.6; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s bounce;
            flex-shrink: 0; border: 3px solid transparent; cursor: pointer;
            pointer-events: auto; /* ×©×™×¤×•×¨: ×× ×™×¢×ª ×ª×§×œ×•×ª ×’×¨×™×¨×” */
            -webkit-user-drag: none; /* ×©×™×¤×•×¨: ×× ×™×¢×ª ×’×¨×™×¨×ª ×”×ª××•× ×” ×‘×“×¤×“×¤×Ÿ */
        }
        .gallery-item.active { opacity: 1; border-color: #FF9F43; transform: scale(1.1) translateY(-2px); box-shadow: 0 8px 15px rgba(255, 159, 67, 0.3); }

        /* ×›×¤×ª×•×¨ ×”×¢×œ××ª ×ª××•× ×” ××ª×•×š ×”×’×œ×¨×™×” */
        .upload-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff5f2;
            border: 3px dashed #FF9F43;
            color: #FF9F43;
            opacity: 1;
        }
        .upload-box:active { transform: scale(0.95); }
        .upload-box svg { width: 28px; height: 28px; }
        .upload-box input { display: none; }

        /* --- Collapsible Controls --- */
        .toggle-menu-btn {
            background: transparent;
            border: none;
            color: #795548;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 5px;
            box-shadow: none;
            width: 100%;
        }
        
        #controls-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease;
        }
        #controls-wrapper.open {
            grid-template-rows: 1fr;
        }
        
        .controls-inner {
            overflow: hidden;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 0 5px;
        }
        #controls-wrapper.open .controls-inner {
            padding-bottom: 10px;
        }

        select, button { padding: 8px 14px; border-radius: var(--btn-radius); border: none; background: #fff; box-shadow: 0 4px 0px #D7CCC8; font-size: 14px; font-weight: bold; color: var(--text-color); cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        button:active, select:active { transform: translateY(4px); box-shadow: 0 0px 0px transparent; }
        button.primary { background-color: #FF9F43; color: white; box-shadow: 0 4px 0px var(--primary-shadow); }
        
        .feature-btn { position: relative; }
        .locked-badge { position: absolute; top: -5px; right: -5px; background: #FF5252; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; font-weight: bold; }

        /* --- Stats --- */
        .stats { display: flex; justify-content: center; gap: 30px; font-weight: bold; color: #795548; font-size: 1.1rem; background: rgba(255,255,255,0.7); padding: 8px 25px; border-radius: 25px; align-self: center; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }

        /* --- Game Board --- */
        #game-area { width: 100%; display: flex; justify-content: center; align-items: center; position: relative; }
        #board { position: relative; background: var(--board-frame); border: 8px solid var(--board-frame); border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1), inset 0 0 15px rgba(0,0,0,0.1); width: 100%; max-width: 420px; aspect-ratio: 1; }
        .tile { position: absolute; background-size: 100% 100%; display: flex; justify-content: center; align-items: center; font-size: 32px; font-weight: 900; color: white; text-shadow: 2px 2px 0 #FF9F43, -1px -1px 0 #FF9F43, 1px -1px 0 #FF9F43, -1px 1px 0 #FF9F43; border: 2px solid rgba(255,255,255,0.4); border-radius: 12px; cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .tile span { display: none; z-index: 2; }
        .show-numbers .tile span { display: block; }

        /* --- Modals --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.6); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(8px); }
        .modal { background: white; padding: 30px 25px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.15); width: 90%; max-width: 360px; animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; align-items: center; border: 4px solid #FFF9C4; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal h2 { color: #FF9F43; margin: 0 0 10px 0; font-size: 2.2rem; }
        .modal p { font-size: 1.1rem; color: #795548; margin: 0 0 20px 0; line-height: 1.4; }
        #win-image { width: 100%; max-height: 220px; object-fit: cover; border-radius: 16px; margin-bottom: 20px; border: 4px solid var(--board-frame); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        #preview-img { max-width: 90%; max-height: 80%; border-radius: 20px; border: 6px solid white; box-shadow: 0 15px 40px rgba(0,0,0,0.2); animation: popIn 0.4s ease-out; }
    </style>
</head>
<body>

<div class="main-layout">
    
    <aside class="ad-sidebar">
        <ins class="adsbygoogle" style="display:inline-block;width:160px;height:600px" data-ad-client="ca-pub-7832188543711021" data-ad-slot="4308525336"></ins>
    </aside>

    <main class="game-column">
        
        <header>
            <div class="gallery-scroller" id="gallery">
            </div>

            <button class="toggle-menu-btn" onclick="toggleMenu()">
                ××¤×©×¨×•×™×•×ª ×•×¢×–×¨×” <span id="menu-icon">â–¼</span>
            </button>

            <div id="controls-wrapper">
                <div class="controls-inner">
                    <select id="difficulty">
                        <option value="3" selected>3x3 (×§×œ)</option>
                        <option value="4">4x4 (×¨×’×™×œ)</option>
                        <option value="4-5">4x5 (××ª×’×¨)</option>
                    </select>
                    <button class="feature-btn" onclick="requestFeature('numbers')">
                        123 <span class="locked-badge" id="badge-numbers">ğŸ”’</span>
                    </button>
                    <button class="feature-btn" onclick="requestFeature('preview')">
                        ğŸ‘ ×”×¦×¦×” <span class="locked-badge" id="badge-preview">ğŸ”’</span>
                    </button>
                    <button class="primary" onclick="initGame()">ğŸ”„ ×¢×¨×‘×‘</button>
                </div>
            </div>

            <div class="stats">
                <span>â± <span id="timer">00:00</span></span>
                <span>ğŸ‘£ <span id="moves">0</span></span>
            </div>
        </header>

        <div class="ad-mobile">
            <ins class="adsbygoogle" style="display:inline-block;width:320px;height:50px" data-ad-client="ca-pub-7832188543711021" data-ad-slot="4308525336"></ins>
        </div>

        <div id="game-area">
            <div id="board"></div>
        </div>

        <div class="ad-mobile">
            <ins class="adsbygoogle" style="display:inline-block;width:320px;height:50px" data-ad-client="ca-pub-7832188543711021" data-ad-slot="4308525336"></ins>
        </div>

    </main>

    <aside class="ad-sidebar">
        <ins class="adsbygoogle" style="display:inline-block;width:160px;height:600px" data-ad-client="ca-pub-7832188543711021" data-ad-slot="4308525336"></ins>
    </aside>

</div>

<div id="win-modal" class="overlay">
    <div class="modal">
        <h2>ğŸ‰ ×›×œ ×”×›×‘×•×“!</h2>
        <p>×¤×ª×¨×ª ××ª ×”×¤××–×œ ×‘-<b id="final-moves"></b> ×¦×¢×“×™×.</p>
        <img id="win-image" src="" alt="×ª××•× ×” ×¤×ª×•×¨×”">
        <button class="primary" style="width: 100%; padding: 14px;" onclick="playRandomNewGame()">××©×—×§ ×—×“×© ğŸˆ</button>
    </div>
</div>

<div id="ad-modal" class="overlay">
    <div class="modal">
        <h2>ğŸ ×¢×–×¨×” ×‘×“×¨×š!</h2>
        <p id="ad-text">×¦×¤×” ×‘×¤×¨×¡×•××ª ×§×¦×¨×” ×›×“×™ ×œ×¤×ª×•×— ×¢×–×¨×” ×œ×¡×™×‘×•×‘ ×”× ×•×›×—×™!</p>
        <div style="display:flex; gap:10px; width:100%; margin-top:15px;" id="ad-buttons">
            <button class="primary" style="flex:1;" id="btn-watch-ad">×¦×¤×” ×¢×›×©×™×• ğŸ¬</button>
            <button style="flex:1; padding:10px; border-radius:25px; border:none; background:#eef2f5; font-weight:bold; color:#5D4037; cursor:pointer;" onclick="closeAdModal()">×œ× ×ª×•×“×”</button>
        </div>
    </div>
</div>

<div id="preview-modal" class="overlay" onclick="this.style.display='none'">
    <img id="preview-img" src="">
</div>

<script>
    // --- ×”×¤×¢×œ×ª ×¤×¨×¡×•××•×ª ×”×ª×¦×•×’×” ---
    window.onload = function() {
        const ads = document.querySelectorAll('.adsbygoogle');
        ads.forEach(() => { try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) {} });
        buildGallery();
        initGame();
    };

    // --- ××ª×—×•×œ ××¢×¨×›×ª AdSense H5 API ---
    window.adsbygoogle = window.adsbygoogle || [];
    const adBreak = function(o) { adsbygoogle.push(o); };
    const adConfig = function(o) { adsbygoogle.push(o); };
    adConfig({ preloadAdBreaks: 'on', sound: 'off' });

    // --- ×œ×•×’×™×§×ª ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×ª×¤×¨×™×˜ ×”××¤×©×¨×•×™×•×ª ---
    function toggleMenu() {
        const wrapper = document.getElementById('controls-wrapper');
        const icon = document.getElementById('menu-icon');
        wrapper.classList.toggle('open');
        icon.innerText = wrapper.classList.contains('open') ? 'â–²' : 'â–¼';
    }

    // --- ×œ×•×’×™×§×ª ×’×œ×¨×™×” ×•×”×¢×œ××ª ×ª××•× ×” ---
    const defaultImages = [
        'IMG_7777.jpeg',
        'https://images.unsplash.com/photo-1583337130417-3346a1be7dee?w=400&q=80',
        'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=400&q=80'
    ];
    let currentImg = defaultImages[0];
    let rows = 3, cols = 3, tiles = [], empty = { r: 2, c: 2 };
    let moves = 0, time = 0, timerInt, isPlaying = true;

    function buildGallery() {
        const gal = document.getElementById('gallery');
        
        gal.innerHTML = `
            <label class="gallery-item upload-box" title="×”×¢×œ×” ×ª××•× ×” ××©×œ×š">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <input type="file" id="upload-input" accept="image/*">
            </label>
        `;

        defaultImages.forEach(imgSrc => {
            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'gallery-item';
            img.setAttribute('draggable', 'false'); 
            if(imgSrc === currentImg) img.classList.add('active');
            img.onclick = () => {
                currentImg = imgSrc;
                document.querySelectorAll('.gallery-item').forEach(el => el.classList.remove('active'));
                img.classList.add('active');
                initGame();
            };
            gal.appendChild(img);
        });

        document.getElementById('upload-input').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) { 
                    currentImg = event.target.result;
                    document.querySelectorAll('.gallery-item').forEach(el => el.classList.remove('active'));
                    initGame(); 
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    }

    // --- AdSense Rewarded Ads Logic (××¢×•×“×›×Ÿ) ---
    let unlockedFeatures = { numbers: false, preview: false };
    let currentFeatureRequest = null;

    function resetFeatures() {
        unlockedFeatures = { numbers: false, preview: false };
        document.getElementById('badge-numbers').style.display = 'block'; 
        document.getElementById('badge-preview').style.display = 'block';
        document.getElementById('board').classList.remove('show-numbers');
    }

    function requestFeature(featureType) {
        if (unlockedFeatures[featureType]) {
            executeFeature(featureType);
            return;
        }

        currentFeatureRequest = featureType;
        let featureName = featureType === 'numbers' ? '××¡×¤×¨×™ ×”×¢×–×¨' : '×”×¦×¦×ª ×”×ª××•× ×”';

        // ××¦×™×’×™× ××ª ×”×—×œ×•×Ÿ ×‘××•×¤×Ÿ ×¢×¦×××™, ×œ×œ× ×”××ª× ×” ×œ×’×•×’×œ
        document.getElementById('ad-text').innerText = `×¦×¤×” ×‘×¤×¨×¡×•××ª ×§×¦×¨×” ×›×“×™ ×œ×¤×ª×•×— ××ª ${featureName} ×¢×“ ×¡×•×£ ×”×¡×™×‘×•×‘!`;
        document.getElementById('ad-modal').style.display = 'flex';
        
        document.getElementById('btn-watch-ad').onclick = () => {
            document.getElementById('ad-modal').style.display = 'none';
            playAd(featureType);
        };
    }

    function playAd(featureType) {
        let adSuccessfullyCalled = false;

        try {
            adBreak({
                type: 'reward',
                name: featureType,
                adViewed: function() { 
                    adSuccessfullyCalled = true; 
                    rewardUser(featureType); 
                },
                adDismissed: function() { 
                    adSuccessfullyCalled = true; 
                    alert('×”×¤×¨×¡×•××ª × ×¡×’×¨×” ×œ×¤× ×™ ×”×¡×™×•×, ×•×œ×›×Ÿ ×”×¢×–×¨×” ×œ× × ×¤×ª×—×”.'); 
                    currentFeatureRequest = null; 
                },
                beforeAd: function() { isPlaying = false; clearInterval(timerInt); },
                afterAd: function() { isPlaying = true; timerInt = setInterval(updateTime, 1000); }
            });
        } catch (e) {
            console.error("AdSense API error:", e);
        }

        // ×’×™×‘×•×™ ×œ×‘×“×™×§×•×ª: ×× AdSense ×œ× ×¢×•×‘×“ (×œ××©×œ ×›×™ ××ª×” ××¨×™×¥ ××§×•××™×ª ×‘××—×©×‘), × ××¤×©×¨ ×œ×¤×ª×•×— ×‘×›×œ ×–××ª ××—×¨×™ ×©× ×™×™×”
        setTimeout(() => {
            if (!adSuccessfullyCalled) {
                console.log("AdSense did not fire. Unlocking feature automatically for testing.");
                rewardUser(featureType);
            }
        }, 1000);
    }

    function closeAdModal() { 
        document.getElementById('ad-modal').style.display = 'none'; 
        currentFeatureRequest = null; 
    }

    function rewardUser(featureType) {
        if (featureType) {
            unlockedFeatures[featureType] = true;
            document.getElementById(`badge-${featureType}`).style.display = 'none';
            executeFeature(featureType);
            currentFeatureRequest = null;
        }
    }

    function executeFeature(featureType) {
        if (featureType === 'numbers') {
            document.getElementById('board').classList.add('show-numbers');
        } else if (featureType === 'preview') {
            document.getElementById('preview-modal').style.display = 'flex';
        }
    }

    // --- ×œ×•×’×™×§×ª ××©×—×§ ---
    const board = document.getElementById('board');
    const diffSel = document.getElementById('difficulty');
    diffSel.onchange = initGame;

    function initGame() {
        moves = 0; time = 0; isPlaying = true;
        document.getElementById('moves').innerText = '0';
        document.getElementById('timer').innerText = '00:00';
        document.getElementById('win-modal').style.display = 'none';
        clearInterval(timerInt);
        timerInt = setInterval(updateTime, 1000);
        resetFeatures();

        const val = diffSel.value;
        if (val === '4-5') { rows = 5; cols = 4; }
        else { rows = parseInt(val); cols = parseInt(val); }

        createBoard();
        setTimeout(shuffle, 150);
    }

    function createBoard() {
        board.innerHTML = ''; tiles = [];
        const tileW = 100 / cols, tileH = 100 / rows;

        for(let r=0; r<rows; r++) {
            tiles[r] = [];
            for(let c=0; c<cols; c++) {
                if(r===rows-1 && c===cols-1) { empty = {r, c}; tiles[r][c] = null; continue; }
                
                const t = document.createElement('div');
                t.className = 'tile';
                t.style.width = tileW + '%'; t.style.height = tileH + '%';
                t.style.left = (c * tileW) + '%'; t.style.top = (r * tileH) + '%';
                t.style.backgroundImage = `url('${currentImg}')`;
                t.style.backgroundSize = `${cols*100}% ${rows*100}%`;
                t.style.backgroundPosition = `${(c/(cols-1))*100}% ${(r/(rows-1))*100}%`;
                
                const num = r*cols + c + 1;
                t.innerHTML = `<span>${num}</span>`;
                t.dataset.r = r; t.dataset.c = c; t.dataset.val = num;

                const moveHandler = (e) => { 
                    if(e.cancelable) e.preventDefault(); 
                    tryMove(parseInt(t.dataset.r), parseInt(t.dataset.c)); 
                };
                t.addEventListener('mousedown', moveHandler);
                t.addEventListener('touchstart', moveHandler, {passive: false});

                tiles[r][c] = t;
                board.appendChild(t);
            }
        }
        document.getElementById('preview-img').src = currentImg;
    }

    function tryMove(r, c) {
        if(!isPlaying) return;
        if(Math.abs(empty.r - r) + Math.abs(empty.c - c) === 1) {
            swap(r, c);
            moves++; document.getElementById('moves').innerText = moves;
            checkWin();
        }
    }

    function swap(r, c) {
        const t = tiles[r][c];
        t.style.left = (empty.c * (100/cols)) + '%'; t.style.top = (empty.r * (100/rows)) + '%';
        t.dataset.r = empty.r; t.dataset.c = empty.c;
        tiles[empty.r][empty.c] = t; tiles[r][c] = null;
        empty = {r, c};
    }

    function shuffle() {
        let last = {r:-1, c:-1};
        const shuffleCount = rows * cols * 20; 
        
        for(let i=0; i<shuffleCount; i++) {
            const neighbors = [];
            if(empty.r > 0) neighbors.push({r:empty.r-1, c:empty.c});
            if(empty.r < rows-1) neighbors.push({r:empty.r+1, c:empty.c});
            if(empty.c > 0) neighbors.push({r:empty.r, c:empty.c-1});
            if(empty.c < cols-1) neighbors.push({r:empty.r, c:empty.c+1});

            const valid = neighbors.filter(n => !(n.r === last.r && n.c === last.c));
            const choice = valid[Math.floor(Math.random() * valid.length)] || neighbors[0];
            swap(choice.r, choice.c);
            last = {r: empty.r, c: empty.c};
        }
        moves = 0; document.getElementById('moves').innerText = '0';
    }

    function checkWin() {
        let count = 1;
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                if(r===rows-1 && c===cols-1) return win();
                if(!tiles[r][c] || parseInt(tiles[r][c].dataset.val) !== count++) return;
            }
        }
    }

    function win() {
        isPlaying = false; clearInterval(timerInt);
        document.getElementById('final-moves').innerText = moves;
        document.getElementById('win-image').src = currentImg;
        setTimeout(() => { document.getElementById('win-modal').style.display = 'flex'; }, 300);
    }

    function playRandomNewGame() {
        document.getElementById('win-modal').style.display = 'none';
        initGame(); 
    }

    function updateTime() {
        time++;
        document.getElementById('timer').innerText = `${Math.floor(time/60).toString().padStart(2,'0')}:${(time%60).toString().padStart(2,'0')}`;
    }
</script>
</body>
</html>
